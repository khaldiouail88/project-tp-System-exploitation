#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <semaphore.h>

#define N 4 // حجم المصفوفات

int B[N][N];
int C[N][N];
int A[N][N];
int tampon[N][N]; // الحافة لتخزين النتائج المؤقتة
int prochain = 0; // مؤشر العنصر التالي للإنتاج
int elements_restants = N; // عدد العناصر المتبقية للإستهلاك

sem_t plein; // سيمافور للحافة الممتلئة
sem_t vide; // سيمافور للحافة الفارغة
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;

// وظيفة الخيط المنتج
void* producteur(void* arg) {
    while (1) {
        sem_wait(&vide);
        pthread_mutex_lock(&mutex);
        
        if (prochain >= N) {
            pthread_mutex_unlock(&mutex);
            sem_post(&plein);
            pthread_exit(NULL);
        }
        
        // حساب صف من المصفوفة الناتجة
        int ligne = prochain;
        prochain++;
        
        pthread_mutex_unlock(&mutex);

        for (int j = 0; j < N; j++) {
            int resultat = 0;
            for (int k = 0; k < N; k++) {
                resultat += B[ligne][k] * C[k][j];
            }
            tampon[ligne][j] = resultat;
        }

        sem_post(&plein);
    }
}

// وظيفة الخيط المستهلك
void* consommateur(void* arg) {
    while (1) {
        sem_wait(&plein);
        pthread_mutex_lock(&mutex);
        
        if (elements_restants == 0) {
            pthread_mutex_unlock(&mutex);
            sem_post(&vide);
            pthread_exit(NULL);
        }
        
        elements_restants--;

        // نسخ القيم من الحافة إلى المصفوفة الناتجة A
        for (int i = 0; i < N; i++) {
            for (int j = 0; j < N; j++) {
                A[i][j] = tampon[i][j];
            }
        }

        pthread_mutex_unlock(&mutex);
        sem_post(&vide);
    }
}

int main() {
    pthread_t threads_prod[N];
    pthread_t thread_cons;

    sem_init(&plein, 0, 0);
    sem_init(&vide, 0, N);

    // تهيئة وعرض المصفوفة B
    printf("matrice B :\n");
    for (int i = 0; i < N; i++) {
        for (int j = 0; j < N; j++) {
            B[i][j] = i + j;
            printf("%d ", B[i][j]);
        }
        printf("\n");
    }
    printf("\n");

    // تهيئة وعرض المصفوفة C
    printf("matrice C :\n");
    for (int i = 0; i < N; i++) {
        for (int j = 0; j < N; j++) {
            C[i][j] = i - j;
            printf("%d ", C[i][j]);
        }
        printf("\n");
    }
    printf("\n");

    // إنشاء خيوط المنتجين
    for (int i = 0; i < N; i++) {
        pthread_create(&threads_prod[i], NULL, producteur, NULL);
    }

    // إنشاء خيط المستهلك
    pthread_create(&thread_cons, NULL, consommateur, NULL);

    // الانتظار حتى نهاية الخيوط
    for (int i = 0; i < N; i++) {
        pthread_join(threads_prod[i], NULL);
    }
    pthread_join(thread_cons, NULL);

    // عرض المصفوفة الناتجة A
    printf("matrice A :\n");
    for (int i = 0; i < N; i++) {
        for (int j = 0; j < N; j++) {
            printf("%d ", A[i][j]);
        }
        printf("\n");
    }

    return 0;
}
